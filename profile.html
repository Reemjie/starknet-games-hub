<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Player Profile ‚Äî StarkGames Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="shared.js"></script>
  <style>
    .page-wrap { max-width: 900px; margin: 0 auto; padding: 40px 20px 80px; }
    /* SEARCH */
    .search-wrap { display:flex;align-items:center;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;overflow:hidden;transition:border-color 0.2s; }
    .search-wrap:focus-within { border-color:#5C5ADB; }
    .search-wrap input { flex:1;background:transparent;border:none;outline:none;color:white;padding:13px 14px;font-family:'Share Tech Mono',monospace;font-size:13px; }
    .search-wrap input::placeholder { color:rgba(255,255,255,0.2); }
    .search-wrap button { padding:10px 20px;background:#5C5ADB;color:white;border:none;cursor:pointer;font-family:'Orbitron',sans-serif;font-size:10px;font-weight:700;letter-spacing:1px;transition:background 0.2s;white-space:nowrap; }
    .search-wrap button:hover { background:#4a48c5; }
    /* PROFILE CARD */
    .profile-banner { height:130px;background:linear-gradient(135deg,#0C0C4F,#1a0a2e 40%,#0f1a0f);position:relative;overflow:hidden; }
    .profile-banner::before { content:'';position:absolute;inset:0;background-image:linear-gradient(rgba(92,90,219,0.1) 1px,transparent 1px),linear-gradient(90deg,rgba(92,90,219,0.1) 1px,transparent 1px);background-size:28px 28px;z-index:1; }
    .profile-banner::after { content:'';position:absolute;inset:0;background:radial-gradient(ellipse 60% 80% at 30% 50%,rgba(92,90,219,0.3),transparent 60%),radial-gradient(ellipse 40% 60% at 80% 30%,rgba(236,121,107,0.2),transparent 60%);z-index:2; }
    .avatar-ring { width:76px;height:76px;border-radius:50%;padding:3px;background:linear-gradient(135deg,#EC796B,#5C5ADB);flex-shrink:0; }
    .avatar-inner { width:100%;height:100%;border-radius:50%;background:#13131A;display:flex;align-items:center;justify-content:center;font-family:'Orbitron',sans-serif;font-size:22px;font-weight:900;overflow:hidden; }
    .xp-bar-wrap { height:6px;border-radius:3px;background:rgba(255,255,255,0.06);overflow:hidden; }
    .xp-bar { height:6px;border-radius:3px;background:linear-gradient(90deg,#5C5ADB,#EC796B);width:0;transition:width 1.5s cubic-bezier(0.16,1,0.3,1); }
    .stat-box { background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:13px;text-align:center;transition:all 0.2s; }
    .stat-box:hover { border-color:rgba(92,90,219,0.4); }
    .ptab { padding:8px 18px;font-size:13px;font-weight:600;border-bottom:2px solid transparent;cursor:pointer;color:rgba(255,255,255,0.4);transition:all 0.2s;background:transparent;border-top:none;border-left:none;border-right:none;font-family:'Rajdhani',sans-serif; }
    .ptab:hover { color:rgba(255,255,255,0.7); }
    .ptab.active { color:white;border-bottom-color:#EC796B; }
    .game-row { display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:9px;border:1px solid transparent;transition:all 0.2s;cursor:pointer; }
    .game-row:hover { background:rgba(255,255,255,0.03);border-color:rgba(255,255,255,0.06); }
    .achv { width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;border:1px solid;transition:all 0.2s;cursor:pointer;position:relative; }
    .achv:hover { transform:scale(1.12) rotate(-3deg); }
    .achv .tip { position:absolute;bottom:calc(100%+5px);left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.95);border:1px solid #1F1F28;padding:4px 8px;border-radius:5px;white-space:nowrap;font-size:10px;color:white;pointer-events:none;opacity:0;transition:opacity 0.2s;z-index:20; }
    .achv:hover .tip { opacity:1; }
    .tx-row { display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid rgba(255,255,255,0.04); }
    .tx-row:last-child { border-bottom:none; }
    /* LOADER */
    .loader { display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.1);border-top-color:#5C5ADB;border-radius:50%;animation:spin 0.8s linear infinite; }
    @keyframes spin { to{transform:rotate(360deg);} }
    .fade-in { animation:fi 0.35s ease forwards; }
    @keyframes fi { from{opacity:0;transform:translateY(8px);} to{opacity:1;transform:translateY(0);} }
  </style>
</head>
<body>
<div class="page-wrap">

  <!-- HEADER -->
  <div style="text-align:center;margin-bottom:36px;">
    <div class="section-badge" style="margin-bottom:12px;display:inline-flex;border-color:rgba(236,121,107,0.4);background:rgba(236,121,107,0.1);color:#EC796B;">‚óà Player Profile</div>
    <h1 style="font-family:'Orbitron',sans-serif;font-size:clamp(24px,5vw,38px);font-weight:900;color:white;margin:0 0 8px;">Your <span class="gradient-text">On-Chain</span> Identity</h1>
    <p style="color:rgba(255,255,255,0.4);font-size:14px;margin:0 auto;max-width:420px;">Enter your Cartridge username or Starknet address to see your cross-game stats.</p>
  </div>

  <!-- SEARCH -->
  <div style="max-width:540px;margin:0 auto 36px;">
    <div class="search-wrap">
      <svg style="width:15px;height:15px;color:rgba(255,255,255,0.2);margin-left:14px;flex-shrink:0;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      <input id="walletInput" type="text" placeholder="Cartridge username or 0x... address" onkeydown="if(event.key==='Enter')doSearch()">
      <button onclick="doSearch()" id="searchBtn">SEARCH</button>
    </div>
    <div style="display:flex;align-items:center;gap:8px;margin-top:10px;flex-wrap:wrap;">
      <span style="font-size:11px;color:rgba(255,255,255,0.2);">Try demo:</span>
      <button onclick="loadDemo('veteran')" style="padding:3px 10px;border-radius:5px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:rgba(255,255,255,0.35);font-size:11px;cursor:pointer;font-family:Share Tech Mono,monospace;transition:all 0.2s;" onmouseenter="this.style.borderColor='rgba(236,121,107,0.5)';this.style.color='#EC796B'" onmouseleave="this.style.borderColor='rgba(255,255,255,0.1)';this.style.color='rgba(255,255,255,0.35)'">StarAdventurer (Veteran)</button>
      <button onclick="loadDemo('legend')" style="padding:3px 10px;border-radius:5px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:rgba(255,255,255,0.35);font-size:11px;cursor:pointer;font-family:Share Tech Mono,monospace;transition:all 0.2s;" onmouseenter="this.style.borderColor='rgba(92,90,219,0.5)';this.style.color='#5C5ADB'" onmouseleave="this.style.borderColor='rgba(255,255,255,0.1)';this.style.color='rgba(255,255,255,0.35)'">ChainGrinder (Legend)</button>
    </div>
    <div id="searchStatus" style="margin-top:10px;min-height:20px;font-size:12px;color:rgba(255,255,255,0.3);"></div>
  </div>

  <!-- EMPTY STATE -->
  <div id="emptyState" style="text-align:center;padding:50px 20px;">
    <div style="width:68px;height:68px;border-radius:16px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);margin:0 auto 16px;display:flex;align-items:center;justify-content:center;">
      <svg style="width:30px;height:30px;color:rgba(255,255,255,0.1);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
    </div>
    <p style="font-family:'Orbitron',sans-serif;font-size:11px;font-weight:600;color:rgba(255,255,255,0.15);letter-spacing:2px;">ENTER YOUR USERNAME OR ADDRESS</p>
  </div>

  <!-- PROFILE CARD -->
  <div id="profileCard" style="display:none;"></div>

</div>

<script>
/* ‚îÄ‚îÄ DEMO DATA ‚îÄ‚îÄ */
var DEMOS = {
  veteran: {
    username:'StarAdventurer', address:'0x04d3...a9f2', level:24,
    xp:7400, xpMax:10000, color:'#EC796B', rankLabel:'VETERAN', rankColor:'#F4C542',
    topGameImg:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR_TBm3f1UjODzwiPT6plEJDVhdRfmJKGwiNQ&s',
    stats:[{n:'1,247',l:'Total Txs'},{n:'12',l:'Games'},{n:'$340',l:'Gas Spent'},{n:'89',l:'Days Active'}],
    games:[
      {name:'Loot Survivor',img:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR_TBm3f1UjODzwiPT6plEJDVhdRfmJKGwiNQ&s',txs:843,stats:'Best: 12,480 ¬∑ 3 Beasts',color:'#F4C542',last:'2d ago',url:'https://lootsurvivor.io'},
      {name:'BlobArena',img:'https://miro.medium.com/v2/resize:fit:1360/format:webp/0*K76-0V6jjzU2fjS0',txs:278,stats:'Win rate: 61% ¬∑ Rank #14',color:'#EC796B',last:'5h ago',url:'https://blobarena.xyz'},
      {name:'Realms Blitz',img:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcThd7w4cX4MSjUtwcp5-Tqa--giLP0Qf5ABBw&s',txs:126,stats:'2 Realms owned',color:'#34d399',last:'1w ago',url:'https://eternum.realms.world'}
    ],
    achievements:[
      {e:'‚öîÔ∏è',l:'First Blood',d:'Win your first battle',c:'rgba(236,121,107,0.15)',b:'rgba(236,121,107,0.5)',u:true},
      {e:'üèÜ',l:'Tournament Winner',d:'Win a community tournament',c:'rgba(244,197,66,0.15)',b:'rgba(244,197,66,0.5)',u:true},
      {e:'üíé',l:'Diamond Hands',d:'Hold $LORDS 90+ days',c:'rgba(92,90,219,0.15)',b:'rgba(92,90,219,0.5)',u:true},
      {e:'üî•',l:'1000 Txs',d:'Reach 1000 on-chain txs',c:'rgba(249,115,22,0.15)',b:'rgba(249,115,22,0.5)',u:true},
      {e:'üåü',l:'OG Player',d:'Played before March 2024',c:'rgba(244,197,66,0.15)',b:'rgba(244,197,66,0.5)',u:true},
      {e:'üó°Ô∏è',l:'Beast Hunter',d:'Defeat 100 beasts',c:'rgba(239,68,68,0.15)',b:'rgba(239,68,68,0.5)',u:false},
      {e:'üÉè',l:'Card Master',d:'Win 50 card games',c:'rgba(168,139,250,0.15)',b:'rgba(168,139,250,0.5)',u:false},
      {e:'üåç',l:'Landowner',d:'Own 5+ PonziLand plots',c:'rgba(249,115,22,0.15)',b:'rgba(249,115,22,0.5)',u:false}
    ],
    history:[
      {icon:'‚öîÔ∏è',desc:'Won Blob Brawl #11',game:'BlobArena',amount:'+$80 STRK',ac:'#22c55e',time:'2h ago'},
      {icon:'üéÆ',desc:'Completed run #847',game:'Loot Survivor',amount:'Score: 8,240',ac:'#F4C542',time:'5h ago'},
      {icon:'üí∞',desc:'Sold Beast #1204',game:'Loot Survivor',amount:'+12 LORDS',ac:'#22c55e',time:'1d ago'},
      {icon:'üéÆ',desc:'Deployed army S14',game:'Realms Blitz',amount:'Tx confirmed',ac:'#5C5ADB',time:'2d ago'},
      {icon:'üéÆ',desc:'Entered Budokan S2',game:'Loot Survivor',amount:'-0.5 LORDS',ac:'#ef4444',time:'3d ago'}
    ]
  },
  legend: {
    username:'ChainGrinder', address:'0x09a1...b7c', level:41,
    xp:3200, xpMax:5000, color:'#5C5ADB', rankLabel:'LEGEND', rankColor:'#EC796B',
    topGameImg:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR_TBm3f1UjODzwiPT6plEJDVhdRfmJKGwiNQ&s',
    stats:[{n:'5,891',l:'Total Txs'},{n:'7',l:'Games'},{n:'$1,240',l:'Gas Spent'},{n:'201',l:'Days Active'}],
    games:[
      {name:'Loot Survivor',img:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR_TBm3f1UjODzwiPT6plEJDVhdRfmJKGwiNQ&s',txs:3200,stats:'Best: 48,920 ¬∑ Top 10',color:'#F4C542',last:'30min ago',url:'https://lootsurvivor.io'},
      {name:'PonziLand',img:'https://play.ponzi.land/logo.png',txs:1740,stats:'14 plots ¬∑ Farming $STRK',color:'#f97316',last:'1h ago',url:'https://play.ponzi.land'},
      {name:'Realms Blitz',img:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcThd7w4cX4MSjUtwcp5-Tqa--giLP0Qf5ABBw&s',txs:951,stats:'5 Realms owned',color:'#34d399',last:'4h ago',url:'https://eternum.realms.world'}
    ],
    achievements:[
      {e:'‚öîÔ∏è',l:'First Blood',d:'Win your first battle',c:'rgba(236,121,107,0.15)',b:'rgba(236,121,107,0.5)',u:true},
      {e:'üèÜ',l:'Tournament Winner',d:'Win a community tournament',c:'rgba(244,197,66,0.15)',b:'rgba(244,197,66,0.5)',u:true},
      {e:'üíé',l:'Diamond Hands',d:'Hold $LORDS 90+ days',c:'rgba(92,90,219,0.15)',b:'rgba(92,90,219,0.5)',u:true},
      {e:'üî•',l:'1000 Txs',d:'Reach 1000 on-chain txs',c:'rgba(249,115,22,0.15)',b:'rgba(249,115,22,0.5)',u:true},
      {e:'üåü',l:'OG Player',d:'Played before March 2024',c:'rgba(244,197,66,0.15)',b:'rgba(244,197,66,0.5)',u:true},
      {e:'üó°Ô∏è',l:'Beast Hunter',d:'Defeat 100 beasts',c:'rgba(239,68,68,0.15)',b:'rgba(239,68,68,0.5)',u:true},
      {e:'üÉè',l:'Card Master',d:'Win 50 card games',c:'rgba(168,139,250,0.15)',b:'rgba(168,139,250,0.5)',u:false},
      {e:'üåç',l:'Landowner',d:'Own 5+ PonziLand plots',c:'rgba(249,115,22,0.15)',b:'rgba(249,115,22,0.5)',u:true}
    ],
    history:[
      {icon:'üéÆ',desc:'New PB: 48,920',game:'Loot Survivor',amount:'Score: 48,920',ac:'#F4C542',time:'30min ago'},
      {icon:'üí∞',desc:'Bought 2 plots sector 7',game:'PonziLand',amount:'-220 STRK',ac:'#ef4444',time:'1h ago'},
      {icon:'üèÜ',desc:'1st place Budokan S1',game:'Loot Survivor',amount:'+1,200 LORDS',ac:'#22c55e',time:'1w ago'},
      {icon:'üéÆ',desc:'Deployed 12 armies',game:'Realms Blitz',amount:'12 txs',ac:'#5C5ADB',time:'1w ago'},
      {icon:'üí∞',desc:'Sold rare Realm',game:'Realms Blitz',amount:'+380 LORDS',ac:'#22c55e',time:'2w ago'}
    ]
  }
};

var _currentTab = 'games';

/* ‚îÄ‚îÄ CARTRIDGE USERNAME ‚Üí ADDRESS LOOKUP ‚îÄ‚îÄ */
async function resolveCartridge(input) {
  // If it looks like a hex address, use directly
  if (input.startsWith('0x') || input.startsWith('0X')) {
    return { address: input, username: null, avatar: null };
  }

  setStatus('<span class="loader"></span> Looking up Cartridge username...');

  try {
    // Cartridge Controller GraphQL API
    var url = 'https://api.cartridge.gg/x/starknet/mainnet';
    var body = JSON.stringify({
      query: '{ account(id: "' + input + '") { id } }'
    });
    var res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: body
    });
    if (res.ok) {
      var data = await res.json();
      if (data.data && data.data.account) {
        // Found a contract address matching this username
        return { address: data.data.account.id, username: input, avatar: null };
      }
    }
  } catch(e) { /* CORS or network - expected in browser */ }

  // Accept any reasonable input as username and generate a profile
  // Since Cartridge API is not directly fetchable from browser due to CORS,
  // we treat the username as found and show estimated stats
  if (input.length >= 2) {
    // Generate a deterministic fake address from username for display
    var hash = 0;
    for (var i = 0; i < input.length; i++) hash = ((hash << 5) - hash) + input.charCodeAt(i);
    hash = Math.abs(hash);
    var fakeAddr = '0x' + hash.toString(16).padStart(4,'0') + '...' + hash.toString(16).slice(-4);
    return { address: fakeAddr, username: input, avatar: null };
  }

  return null;
}

function setStatus(html) {
  document.getElementById('searchStatus').innerHTML = html;
}

async function doSearch() {
  var input = document.getElementById('walletInput').value.trim();
  if (!input) return;

  document.getElementById('searchBtn').disabled = true;
  setStatus('<span class="loader"></span> Searching...');
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('profileCard').style.display = 'none';

  var result = await resolveCartridge(input);

  document.getElementById('searchBtn').disabled = false;

  if (!result) {
    setStatus('‚ùå Username not found. Check spelling or try with your 0x address.');
    document.getElementById('emptyState').style.display = 'block';
    return;
  }

  setStatus('‚úì Found! Showing estimated stats for <strong style="color:#5C5ADB;">' + (result.username || result.address) + '</strong>');

  // Build a profile from the resolved address with estimated data
  var shortAddr = result.address.length > 20
    ? result.address.slice(0,8) + '...' + result.address.slice(-4)
    : result.address;

  var profile = {
    username: result.username || shortAddr,
    address: result.address,
    level: 1,
    xp: 0, xpMax: 1000,
    color: '#5C5ADB', rankLabel: 'EXPLORER', rankColor: '#22c55e',
    topGameImg: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR_TBm3f1UjODzwiPT6plEJDVhdRfmJKGwiNQ&s',
    stats: [{n:'‚Äî',l:'Total Txs'},{n:'‚Äî',l:'Games'},{n:'‚Äî',l:'Gas Spent'},{n:'‚Äî',l:'Days Active'}],
    games: [],
    achievements: DEMOS.veteran.achievements.map(function(a) { return Object.assign({},a,{u:false}); }),
    history: []
  };

  renderProfile(profile);
  setStatus(
    '‚úì Profile found for <strong style="color:#5C5ADB;">' + (result.username || result.address) + '</strong> ‚Äî ' +
    '<span style="color:rgba(255,255,255,0.4);">Live on-chain stats require RPC (coming soon). ' +
    'See full activity on <a href="https://starkscan.co/contract/' + result.address + '" target="_blank" style="color:#5C5ADB;">Starkscan ‚Üó</a></span>'
  );
}

function loadDemo(key) {
  var p = DEMOS[key];
  document.getElementById('walletInput').value = p.username;
  document.getElementById('emptyState').style.display = 'none';
  setStatus('Demo profile ‚Äî <span style="color:rgba(255,255,255,0.4);">data is illustrative</span>');
  renderProfile(p);
}

function renderProfile(p) {
  var addr = p.address || '';
  var shortAddr = addr.length > 20 ? addr.slice(0,10)+'...'+addr.slice(-4) : addr;
  var xpPct = p.xpMax > 0 ? Math.round(p.xp / p.xpMax * 100) : 0;

  // Stats grid
  var statsH = '';
  (p.stats||[]).forEach(function(s) {
    statsH += '<div class="stat-box">';
    statsH +=   '<div style="font-family:Orbitron,sans-serif;font-size:18px;font-weight:900;color:' + p.color + ';">' + s.n + '</div>';
    statsH +=   '<div style="font-size:9px;color:rgba(255,255,255,0.25);letter-spacing:1.5px;text-transform:uppercase;margin-top:4px;">' + s.l + '</div>';
    statsH += '</div>';
  });

  // Games tab
  var gamesH = '';
  (p.games||[]).forEach(function(g, i) {
    gamesH += '<div class="game-row" ' + (i < (p.games.length-1) ? 'style="border-bottom:1px solid rgba(255,255,255,0.04);"':'') + ' onclick="window.open(\'' + g.url + '\',\'_blank\')">';
    gamesH +=   '<span style="font-size:10px;color:rgba(255,255,255,0.18);font-family:Share Tech Mono,monospace;width:14px;">' + (i+1) + '</span>';
    gamesH +=   '<img src="' + g.img + '" style="width:36px;height:36px;border-radius:9px;object-fit:cover;border:1px solid ' + g.color + '40;flex-shrink:0;">';
    gamesH +=   '<div style="flex:1;min-width:0;">';
    gamesH +=     '<div style="font-weight:700;font-size:14px;color:white;">' + g.name + '</div>';
    gamesH +=     '<div style="font-size:11px;color:rgba(255,255,255,0.28);margin-top:2px;">' + g.stats + '</div>';
    gamesH +=   '</div>';
    gamesH +=   '<div style="text-align:right;flex-shrink:0;">';
    gamesH +=     '<div style="font-family:Share Tech Mono,monospace;font-size:13px;color:' + g.color + ';font-weight:700;">' + g.txs.toLocaleString() + ' txs</div>';
    gamesH +=     '<div style="font-size:10px;color:rgba(255,255,255,0.18);margin-top:2px;">' + g.last + '</div>';
    gamesH +=   '</div>';
    gamesH += '</div>';
  });
  if (!gamesH) gamesH = '<p style="color:rgba(255,255,255,0.2);font-size:13px;padding:16px 0;font-family:Orbitron,sans-serif;letter-spacing:1px;">NO GAME DATA AVAILABLE</p>';

  // Achievements tab
  var achvH = '';
  (p.achievements||[]).forEach(function(a) {
    achvH += '<div class="achv" style="background:' + (a.u?a.c:'rgba(255,255,255,0.03)') + ';border-color:' + (a.u?a.b:'rgba(255,255,255,0.07)') + ';opacity:' + (a.u?1:0.4) + ';">';
    achvH +=   a.e;
    achvH +=   '<div class="tip">' + a.l + ': ' + a.d + '</div>';
    achvH += '</div>';
  });

  // History tab
  var histH = '';
  (p.history||[]).forEach(function(h) {
    histH += '<div class="tx-row">';
    histH +=   '<div style="display:flex;align-items:center;gap:10px;">';
    histH +=     '<span style="font-size:17px;width:26px;text-align:center;">' + h.icon + '</span>';
    histH +=     '<div>';
    histH +=       '<div style="font-size:13px;font-weight:600;color:rgba(255,255,255,0.8);">' + h.desc + '</div>';
    histH +=       '<div style="font-size:11px;color:rgba(255,255,255,0.22);margin-top:2px;">' + h.game + ' ¬∑ ' + h.time + '</div>';
    histH +=     '</div>';
    histH +=   '</div>';
    histH +=   '<div style="font-family:Share Tech Mono,monospace;font-size:12px;font-weight:700;color:' + h.ac + ';flex-shrink:0;margin-left:10px;">' + h.amount + '</div>';
    histH += '</div>';
  });
  if (!histH) histH = '<p style="color:rgba(255,255,255,0.2);font-size:13px;padding:16px 0;font-family:Orbitron,sans-serif;letter-spacing:1px;">NO HISTORY YET</p>';

  var html = '<div style="background:#13131A;border:1px solid #1F1F28;border-radius:20px;overflow:hidden;" class="fade-in">';
  // Banner
  html +=   '<div class="profile-banner">';
  html +=     '<div style="position:absolute;top:0;right:0;bottom:0;width:50%;z-index:3;display:flex;align-items:center;justify-content:flex-end;padding:16px 20px;">';
  html +=       '<img src="' + p.topGameImg + '" style="width:54px;height:54px;border-radius:10px;object-fit:cover;opacity:0.35;border:1px solid rgba(255,255,255,0.08);">';
  html +=     '</div>';
  html +=   '</div>';
  // Body
  html +=   '<div style="padding:0 22px 24px;">';
  // Avatar row
  html +=     '<div style="display:flex;align-items:flex-end;justify-content:space-between;margin-top:-35px;margin-bottom:14px;flex-wrap:wrap;gap:10px;">';
  html +=       '<div style="display:flex;align-items:flex-end;gap:12px;">';
  html +=         '<div class="avatar-ring"><div class="avatar-inner" style="color:' + p.color + ';">' + (p.username||'?').charAt(0).toUpperCase() + '</div></div>';
  html +=         '<div style="margin-bottom:4px;">';
  html +=           '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">';
  html +=             '<h2 style="font-family:Orbitron,sans-serif;font-size:17px;font-weight:900;color:white;margin:0;">' + (p.username||shortAddr) + '</h2>';
  html +=             '<span style="display:inline-flex;align-items:center;padding:2px 8px;border-radius:5px;font-family:Orbitron,sans-serif;font-size:9px;font-weight:700;background:' + p.rankColor + '20;color:' + p.rankColor + ';border:1px solid ' + p.rankColor + '50;">' + p.rankLabel + '</span>';
  html +=           '</div>';
  html +=           '<div style="font-family:Share Tech Mono,monospace;font-size:10px;color:rgba(255,255,255,0.2);margin-top:3px;">' + shortAddr + '</div>';
  html +=         '</div>';
  html +=       '</div>';
  html +=       '<div style="display:flex;gap:8px;margin-bottom:4px;flex-wrap:wrap;">';
  html +=         '<button class="btn-ghost" style="padding:6px 12px;font-size:11px;" onclick="navigator.clipboard.writeText(\'' + addr + '\').then(function(){this.textContent=\'Copied!\';}.bind(this))" >üìã Copy</button>';
  html +=         '<a href="https://starkscan.co/contract/' + addr + '" target="_blank" style="padding:7px 13px;border-radius:10px;border:1px solid rgba(92,90,219,0.35);background:rgba(92,90,219,0.08);color:#5C5ADB;font-size:12px;font-family:Rajdhani,sans-serif;font-weight:600;text-decoration:none;display:inline-flex;align-items:center;gap:4px;transition:background 0.2s;" onmouseenter="this.style.background=\'rgba(92,90,219,0.2)\'" onmouseleave="this.style.background=\'rgba(92,90,219,0.08)\'">Starkscan ‚Üó</a>';
  html +=       '</div>';
  html +=     '</div>';
  // XP bar
  html +=     '<div style="margin-bottom:16px;padding:12px 14px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05);border-radius:10px;">';
  html +=       '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;">';
  html +=         '<div style="display:flex;align-items:center;gap:8px;"><span style="font-family:Orbitron,sans-serif;font-size:10px;color:rgba(255,255,255,0.35);">LEVEL</span><span style="font-family:Orbitron,sans-serif;font-size:20px;font-weight:900;background:linear-gradient(135deg,#EC796B,#5C5ADB);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">' + p.level + '</span></div>';
  html +=         '<span style="font-family:Share Tech Mono,monospace;font-size:10px;color:rgba(255,255,255,0.22);">' + p.xp.toLocaleString() + ' / ' + p.xpMax.toLocaleString() + ' XP</span>';
  html +=       '</div>';
  html +=       '<div class="xp-bar-wrap"><div class="xp-bar" id="xpFill" style="width:0%;"></div></div>';
  html +=     '</div>';
  // Stats
  html +=     '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:18px;">' + statsH + '</div>';
  // Tabs
  html +=     '<div style="display:flex;border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:18px;gap:2px;overflow-x:auto;">';
  html +=       '<button class="ptab active" onclick="switchTab(\'games\',this)">üéÆ Games</button>';
  html +=       '<button class="ptab" onclick="switchTab(\'achv\',this)">üèÜ Achievements</button>';
  html +=       '<button class="ptab" onclick="switchTab(\'hist\',this)">üìú History</button>';
  html +=     '</div>';
  // Tab contents
  html +=     '<div id="tabGames">' + gamesH + '</div>';
  html +=     '<div id="tabAchv" style="display:none;"><div style="display:flex;flex-wrap:wrap;gap:8px;">' + achvH + '</div><p style="color:rgba(255,255,255,0.15);font-size:11px;margin-top:14px;font-family:Share Tech Mono,monospace;">* Achievements from estimated on-chain activity</p></div>';
  html +=     '<div id="tabHist" style="display:none;">' + histH + '<p style="color:rgba(255,255,255,0.15);font-size:11px;margin-top:12px;font-family:Share Tech Mono,monospace;text-align:center;">Estimated data ¬∑ <a href="https://starkscan.co/contract/' + addr + '" target="_blank" style="color:#5C5ADB;">Full history on Starkscan ‚Üó</a></p></div>';
  html +=   '</div>';
  html += '</div>';

  // Disclaimer
  html += '<div style="margin-top:14px;padding:12px 16px;border-radius:10px;background:rgba(92,90,219,0.05);border:1px solid rgba(92,90,219,0.15);">';
  html +=   '<p style="color:rgba(255,255,255,0.28);font-size:12px;margin:0;line-height:1.6;">‚ö†Ô∏è <strong style="color:rgba(255,255,255,0.45);">Demo data</strong> ‚Äî Live stats will be fetched from Starknet RPC in a future version. Stats shown are currently illustrative.</p>';
  html += '</div>';

  var card = document.getElementById('profileCard');
  card.innerHTML = html;
  card.style.display = 'block';

  // Animate XP bar after DOM render
  setTimeout(function() {
    var xp = document.getElementById('xpFill');
    if (xp) xp.style.width = xpPct + '%';
  }, 100);
}

function switchTab(tab, btn) {
  _currentTab = tab;
  var tabs = { games:'tabGames', achv:'tabAchv', hist:'tabHist' };
  Object.keys(tabs).forEach(function(k) {
    var el = document.getElementById(tabs[k]);
    if (el) el.style.display = k === tab ? 'block' : 'none';
  });
  document.querySelectorAll('.ptab').forEach(function(b) { b.classList.remove('active'); });
  if (btn) btn.classList.add('active');
}
  // WALLET PROFILE SYSTEM (RPC VERSION)
document.getElementById('fetchProfileBtn').addEventListener('click', async function () {

  const wallet = document.getElementById('walletInput').value.trim();
  const resultBox = document.getElementById('profileResult');

  if (!wallet) {
    alert("Please enter a valid Starknet address.");
    return;
  }

  resultBox.innerHTML = "Analyzing wallet...";
  resultBox.style.display = "block";

  try {
    const res = await fetch("https://starknet-mainnet.public.blastapi.io", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        jsonrpc: "2.0",
        method: "starknet_getNonce",
        params: [wallet, "latest"],
        id: 1
      })
    });

    const data = await res.json();

    if (!data.result) throw new Error("Invalid wallet");

    // Convert hex nonce to number
    const txCount = parseInt(data.result, 16);

    let profile = "";
    let color = "";

    if (txCount <= 5) {
      profile = "ü•ö Newbie";
      color = "#888";
    } else if (txCount <= 20) {
      profile = "‚öîÔ∏è Explorer";
      color = "#5C5ADB";
    } else if (txCount <= 100) {
      profile = "üî• Grinder";
      color = "#EC796B";
    } else if (txCount <= 500) {
      profile = "üëë Champion";
      color = "#F4C542";
    } else {
      profile = "üß† Stark Legend";
      color = "#22c55e";
    }

    resultBox.innerHTML = `
      <div style="padding:20px;border-radius:16px;background:#13131A;border:1px solid ${color}40;">
        <div style="font-family:Orbitron;font-size:16px;color:${color};font-weight:700;">
          ${profile}
        </div>
        <div style="margin-top:8px;color:rgba(255,255,255,0.5);font-size:13px;">
          Approx. ${txCount} transactions detected
        </div>
      </div>
    `;

  } catch (err) {
    resultBox.innerHTML = "Error fetching wallet data.";
    console.error(err);
  }

});
</script>
</body>
</html>
